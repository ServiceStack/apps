<html>
<head>
<title>Instant Client Apps</title>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright 2020. ServiceStack, Inc">
<link rel="icon" type="image/svg+xml" href="assets/img/logo.svg">
<link rel="stylesheet" href="litewind.css">
<style>
a { color: #007bff }
.container { }
.w-section,.w-container {width:900px}
.w-wide-section { width: 1200px }
.w-wide-section-half { width: 600px }
.h-embed{height:700px}.m-t-embed{margin-top:-700px}
.invalid-feedback::before{content:"\2718"}
.is-invalid::after{content:"\2718"}

.hide-enabled,.loading,.show-loading,.show-error,.show-embed,.show-auth {display:none}
.has-error .hide-error{display:none !important}

.nourl .hide-enabled{display:block}
.show-enabled{display:block}
.nourl .show-enabled{display:none}
.has-error .show-error{display:block}
.requires-auth .show-auth{display:block}
.loading .show-loading{display:block}
.loading .show-loading.flex{display:flex}
.loading .hide-loading{display:none}
.has-embed .show-embed{display:block}

[data-open] { display: none; cursor: pointer }
.csharp .show-csharp,.typescript .show-typescript,.dart .show-dart,.java .show-java,.kotlin .show-kotlin,.swift .show-swift,.vbnet .show-vbnet,.fsharp .show-fsharp
{ display: flex }

.nourl .lang {filter:grayscale(100%);opacity:.5;box-shadow:none;cursor:default}
.lang img {transform:scale(.90)}
.lang:hover {background-color:#fff}
.lang:active, .lang.active, .tag.active {
    background-color: #fff;
    --tw-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.16);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow);
}
INPUT.text-3xl { line-height: 2.5rem }
#choose-api .awesomplete { width: 100%; }
#apiForm .awesomplete { display: block }
#apiForm .awesomplete ul { overflow-y: auto; max-height: 19.5rem; }
#apiForm .awesomplete ul::-webkit-scrollbar { width:5px; height:8px; }
#apiForm .awesomplete ul::-webkit-scrollbar-thumb { background-color: #e0e0e0; }

@media (min-width: 414px) {
    .just-add { display:none }
    .w-25{width:3.125rem}.h-25{height:3.125rem}
    .text-3xl{font-size: 1rem;line-height: 1.5rem}
    .text-6xl { font-size: 1.875rem }
    .w-section,.w-container { width: 414px }
}
@media (min-width: 768px) {
    .just-add { display:block }
    .w-25{width:6.25rem}.h-25{height:6.25rem}
    .text-3xl { font-size: 1.875rem;line-height: 2.25rem }
    .text-6xl { font-size: 3.75rem;line-height: 1 }
    .w-section,.w-container { width: 768px }
}
@media only screen and (min-width:900px) {
    .w-section,.w-container { width: 900px }
}
</style>

<script>let exports = { __esModule:true }, module = { exports:exports }; function require(name) { return exports[name] || window[name] }</script>
<script defer src="https://unpkg.com/@servicestack/client@1.0.45/dist/servicestack-client.min.js"></script>
<script defer src="dtos.js"></script>
</head>
<body class="m-0 font-sans bg-gray-50 nourl">
<i hidden>{{ '/js/hot-fileloader.js' |> ifDebugIncludeScript }}</i>

<div class="container flex flex-col place-items-center">
    <h1 class="mt-4 mb-1 text-6xl font-semibold text-center text-gray-700">Instant Client Apps</h1>
    <small class="just-add mt-1 mb-2 text-base text-gray-400">just add</small>

    <form id="formUrl">
        <div class="mt-2 w-section flex justify-between">
            <select id="scheme" class="border py-2 px-3 text-grey-900 text-3xl shadow bg-none">
                <option value="https">https://</option>
                <option value="http">http://</option>
            </select>
            <input id="baseUrl" class="flex-grow border py-2 px-3 text-grey-900 text-3xl shadow" type="text" placeholder="ServiceStack Base URL">
        </div>
        <div id="btn-clear" class="show-enabled absolute text-right w-section">
            <div title="clear" class="float-right w-6 text-2xl text-gray-500 cursor-pointer" style="margin:-2.85rem 1rem 0 0">&#10005;</div>
        </div>
        <div class="btn-help hide-enabled absolute text-right w-section">
            <a  href="https://docs.servicestack.net/create-your-first-webservice"
                title="Create APIs" class="float-right w-6 text-2xl text-gray-500 cursor-pointer" style="margin:-2.85rem 1rem 0 0">&quest;</a>
        </div>

        <div class="text-center">
            <div class="error-summary invalid-feedback my-1"></div>
            <small class="text-base text-gray-400">
                try <a href="#techstacks.io">techstacks.io</a>
            </small>
        </div>
    </form>

    <div class="flex justify-evenly langs m-4 pb-6 w-container">
        <span data-lang="csharp" class="lang project shadow-lg rounded-full cursor-pointer" title="C#" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/csharp.svg" alt="C# logo">
        </span>

        <span data-lang="typescript" class="lang project hell shadow-lg rounded-full cursor-pointer" title="Node.js TypeScript" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/typescript.svg" alt="Node.js logo">
        </span>

        <span data-lang="dart" class="lang shadow-lg rounded-full cursor-pointer" title="Dart" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/dart.svg" alt="Dart logo">
        </span>

        <span data-lang="java" class="lang shadow-lg rounded-full cursor-pointer" title="Java" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/java.svg" alt="Java logo">
        </span>

        <span data-lang="kotlin" class="lang shadow-lg rounded-full cursor-pointer" title="Kotlin" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/kotlin.svg" alt="Kotlin logo">
        </span>

        <span data-lang="swift" class="lang shadow-lg rounded-full cursor-pointer" title="Swift" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/swift.svg" alt="Swift logo">
        </span>

        <span data-lang="vbnet" class="lang project shadow-lg rounded-full cursor-pointer" title="VB" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/vb.svg" alt="VB.NET logo">
        </span>

        <span data-lang="fsharp" class="lang shadow-lg rounded-full cursor-pointer" title="F#" data-click="selectLang">
            <img class="w-25 h-25" src="assets/img/fsharp.svg" alt="F# logo">
        </span>
    </div>
    
    <div class="hide-enabled text-xl gray-500">
        <p>
            Services built using <a href="https://servicestack.net">ServiceStack</a> can generate instant Client Apps for all
            <a href="https://docs.servicestack.net/add-servicestack-reference">supported languages</a> above.
        </p>
        <p>
            <a href="https://docs.servicestack.net/clients-overview">Generic Service Clients</a>
            use the native language DTOs to enable its productive end-to-end typed APIs.
        </p>
    </div>

    <div id="error-summary" class="show-error w-section mt-8 bg-red-100 border-l-4 border-red-300 text-red-dark p-4" role="alert">
        <b></b>
        <p></p>
    </div>

    <div class="show-embed hide-error">
        <div id="embed" class="hide-loading w-wide-section shadow h-embed"></div>
        <div id="embed-loading" class="show-loading w-wide-section h-embed flex place-items-center bg-white shadow">
            <div class="w-wide-section text-center text-2xl flex justify-center">
                Loading
                <img class="w-8 h-8 pl-1 pt-1" src="assets/img/loading.svg" alt="loading...">
            </div>
        </div>
        
        <div id="customize-embed" class="flex">
            <div class="flex-1">
                <div id="tags" class="mt-2 flex" style="min-height:1.5rem"></div>
                <div class="show-auth absolute" style="margin:1.3em 0 0 565px;z-index: 1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-6 h-6">
                        <title>Requires Authentication</title>
                        <path fill="#374151" d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
                    </svg>
                </div>
                <label id="choose-api">
                    <input id="txtRequest" type="text" spellcheck="false" placeholder="Choose API"
                           class="flex-grow border mt-1 py-2 px-3 text-grey-900 text-3xl shadow w-full">
                </label>
                <div id="apiForm" class="mt-2 w-full"></div>
            </div>
            <div class="flex-shrink px-1"></div>
            <div class="flex-1">
                <div class="mt-2 text-gray-500 font-semibold uppercase text-right">Customize Download</div>
                <label id="customize-download">
                    <input id="txtProjectName" type="text" spellcheck="false" placeholder="ProjectName"
                           onkeypress="return event.charCode !== 32"
                           onchange="this.value = this.value.replace(/\s/g,'')"
                           oninput="updateDownload()"
                           class="flex-grow border mt-1 py-2 px-3 text-grey-900 text-3xl shadow w-full">
                </label>
                <div id="customForm" class="mt-2 w-full">
                    <div class="shadow overflow-hidden sm:rounded">
                        <div class="px-4 py-5 bg-white sm:p-6">
                            <div id="includeDtos"></div>
                            <h3 class="uppercase my-4 text-base font-medium text-gray-900">Download</h3>
                            <div id="zip">
                                <a href="" class="flex justify-center">
                                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                                    <span id="lblProject" class="ml-1 text-2xl leading-9">MyApp</span>
                                </a>
                            </div>
                            <h3 class="uppercase my-4 text-base font-medium text-gray-900">Open With...</h3>
                            <div id="xopen" class="flex justify-center gap-5">
                                <div data-open="folder" data-click="openWith" class="flex flex-col items-center text-center show-csharp show-typescript show-dart show-java show-kotlin show-swift show-vbnet show-fsharp">
                                    <img class="w-10 h-10" src="assets/img/folder.svg" alt="Folder Icon">
                                    <span class="text-gray-500">Folder</span>
                                </div>
                                <div data-open="vscode" data-click="openWith" class="flex flex-col items-center text-center show-csharp show-typescript show-dart show-java show-kotlin show-swift show-vbnet show-fsharp">
                                    <img class="w-10 h-10" src="assets/img/vscode.svg" alt="VS Code Icon">
                                    <span class="text-gray-500">VS Code</span>
                                </div>
                                <div data-open="rider" data-click="openWith" class="flex flex-col items-center text-center show-csharp show-vbnet show-fsharp">
                                    <img class="w-10 h-10" src="assets/img/rider.svg" alt="Rider Icon">
                                    <span class="text-gray-500">Rider</span>
                                </div>
                                <div data-open="devenv" data-click="openWith" class="flex flex-col items-center text-center show-csharp show-vbnet show-fsharp">
                                    <img class="w-10 h-10" src="assets/img/visualstudio.svg" alt="Visual Studio Icon">
                                    <span class="text-gray-500">Visual Studio</span>
                                </div>
                                <div data-open="webstorm" data-click="openWith" class="flex flex-col items-center text-center show-typescript show-dart">
                                    <img class="w-10 h-10" src="assets/img/webstorm.svg" alt="Visual Studio Icon">
                                    <span class="text-gray-500">WebStorm</span>
                                </div>
                                <div data-open="androidstudio" data-click="openWith" class="flex flex-col items-center text-center show-dart show-java show-kotlin">
                                    <img class="w-10 h-10" src="assets/img/androidstudio.svg" alt="Android Studio Icon">
                                    <span class="text-gray-500">Android Studio</span>
                                </div>
                                <div data-open="idea" data-click="openWith" class="flex flex-col items-center text-center show-java show-kotlin">
                                    <img class="w-10 h-10" src="assets/img/idea.svg" alt="Intellij IDEA Icon">
                                    <span class="text-gray-500">Intellij IDEA</span>
                                </div>
                                <div data-open="appcode" data-click="openWith" class="flex flex-col items-center text-center show-swift">
                                    <img class="w-10 h-10" src="assets/img/appcode.svg" alt="AppCode Icon">
                                    <span class="text-gray-500">App Code</span>
                                </div>
                                <div data-open="xcode" data-click="openWith" class="flex flex-col items-center text-center show-swift">
                                    <img class="w-10 h-10" src="assets/img/xcode.svg" alt="Xcode Icon">
                                    <span class="text-gray-500">Xcode</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="foot show-embed border-t-1 py-2 text-center text-gray-500" style="margin-top:12rem">
    <div>
        <a href="https://servicestack.net" title="servicestack.net" class="opacity-25 hover:opacity-100">
            <svg class="w-6 h-6 inline-block" viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'> <style> .path{} </style><g id='servicestack-svg'><path class='path' stroke='null' d='m16.564516,43.33871c16.307057,2.035887 54.629638,20.41875 60.67742,46.306452l-78.241936,0c19.859879,-1.616734 36.825605,-27.344758 17.564516,-46.306452zm6.387097,-30.33871c6.446976,7.105645 9.520766,16.74617 9.26129,26.666129c16.546573,6.726411 41.376412,24.690121 46.625807,49.979033l19.161291,0c-8.123589,-43.132863 -54.529839,-73.551412 -75.048388,-76.645162z' /></g></svg>
        </a>
        &copy; 2021 ServiceStack, Inc.
    </div>
</div>

<script>
let LOG = location.search.indexOf('log=1') >= 0 || true;
/** @type {JsonServiceClient} */
let client = null;
let LANGS = ['csharp','typescript','dart','java','kotlin','swift','vbnet','fsharp'];
let M = {
    baseUrl: '',
    scheme: 'https',
    requiresAuth: false,
    isEnabled: false,
    lang: '',
    op: null,
    include:'',
    errorStatus:null,
    setBaseUrl(baseUrl) {
        this.baseUrl = baseUrl;
        if (this.baseUrl.indexOf('://') >= 0) {
            this.scheme = leftPart(this.baseUrl,'://');
            this.baseUrl = rightPart(this.baseUrl,'://');
        }
        this.syncClasses();
        return this.baseUrl;
    },
    setScheme(value) {
      this.scheme = value;
      this.syncClasses();
      return this.scheme;
    },
    setInclude(id) {
        localStorage.setItem('include:active',this.include=id);
        this.syncClasses();
    },
    getInclude() {
        return localStorage.getItem('include:active') || 'includeAll';
    },
    setLang(lang) {
        if (lang && LANGS.indexOf(lang) === -1) {
            if (LOG) console.log(`Not a valid language: ${lang}`);
            return;
        }
        localStorage.setItem('lang:active',this.lang=lang);
        activateLang();
        this.syncClasses();
    },
    getLang() {
        return localStorage.getItem('lang:active') || 'csharp';
    },
    setErrorStatus(status) {
        this.errorStatus = status;
        this.syncClasses();
    },
    slug() {
        return this.baseUrl ? urlToSlug(this.baseUrl) : null;
    },
    reset() {
        $('#baseUrl').value = $('#txtRequest').value = $('#apiForm').innerHTML = this.baseUrl = '';
        this.requiresAuth = this.isEnabled = false;
        this.errorStatus = this.op = null;
        clearErrorSummary();
        updateDownload();
        activateLang();
        onUrlChange();
        this.syncClasses();
    },
    syncClasses() {
        let cls = ['m-0 font-sans bg-gray-50'];
        if (!this.baseUrl) {
            cls.push('nourl');
        } else if (this.baseUrl && this.lang) {
            cls.push('has-embed');
        }
        if (this.lang) {
            cls.push(this.lang);
        }
        if (this.errorStatus) {
            cls.push('has-error');
        }
        if (this.requiresAuth) {
            cls.push('requires-auth');
        }
        document.body.className = cls.join(' ');
    }
};


function $(sel, el) {
    return typeof sel === "string" ? (el || document).querySelector(sel) : sel || null;
}
function $$(sel, el) {
    return typeof sel === "string" 
        ? Array.prototype.slice.call((el || document).querySelectorAll(sel)) 
        : Array.isArray(sel) 
            ? sel 
            : [sel];
}
function on(sel, handlers) {
    $$(sel).forEach(e => {
        Object.keys(handlers).forEach(function (evt) {
            let fn = handlers[evt];
            if (typeof evt === 'string' && typeof fn === 'function') {
                e.addEventListener(evt, fn.bind(e));
            }
        })
    });
}

function urlError(error) {
    $("#formUrl .invalid-feedback").innerHTML = error.message;
    if (error.field)
        $(error.field).classList.add('is-invalid');
    $("#formUrl").classList.add('error');
}
function clearErrors($el) {
    $el.classList.remove('error');
    $el.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
    $el.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
}
function isInteger(str) {
    let n = Math.floor(Number(str));
    return n !== Infinity && String(n) === str && n >= 0;
}
function urlToSlug(url) {
    let slug = url;
    if (slug.startsWith("https://"))
        slug = slug.substring("https://".length);
    else if (slug.startsWith("http://"))
        slug = "http:" + slug.substring("http://".length);
    slug = slug.replace(/\//g, ':');
    return slug;
}
function urlFromSlug(slug) {
    let url = slug;
    let isUrl = url.startsWith("https://") || url.startsWith("http://");
    let scheme = !isUrl && (url.startsWith("http:") || url.startsWith("https:"))
        ? leftPart(url,':')
        : null;
    if (scheme != null)
        url = rightPart(url,':');

    let firstPos = url.indexOf(':');
    if (!isUrl && firstPos >= 0) {
        let atPort = rightPart(url,':');
        let delim1Pos = atPort.indexOf(':');
        let delim2Pos = atPort.indexOf('/');
        let endPos = delim1Pos >= 0 && delim2Pos >= 0
            ? Math.min(delim1Pos, delim2Pos)
            : Math.max(delim1Pos, delim2Pos);
        let testPort = endPos >= 0
            ? atPort.substring(0,endPos)
            : atPort.substring(0,atPort.length - 1);
        url = isInteger(testPort)
            ? leftPart(url,':') + ':' + unSlash(atPort)
            : leftPart(url,':') + '/' + unSlash(atPort);
    }
    url = decodeURIComponent(url);
    if (!isUrl) {
        url = scheme != null
            ? scheme + "://" + url
            : "https://" + url;
    }
    return url;
}
function unSlash(urlComponent) {
    // don't replace ':' after '('...)
    if (urlComponent.indexOf('(') >= 0) {
        let target = leftPart(urlComponent,'(');
        let suffix = rightPart(urlComponent,'(');
        return target.replace(/:/g, '/') + '(' + suffix;
    }
    return urlComponent.replace(/:/g, '/');
}

function handleHash(path) {
    if (!path) return;
    if (path.indexOf('[') >= 0)
        throw new Error(`Invalid path: ${path}`);
    let segments = path.split('/');
    let url = urlFromSlug(segments[0]);
    let parts = url.split('://');
    let hasScheme = parts.length > 1;
    let baseUrl = !hasScheme
        ? parts[0]
        : parts[1];
    if (hasScheme) {
        let scheme = parts[0];
        if (scheme !== 'http' && scheme !== 'https') {
            return urlError({ message:'Invalid Scheme', field:'#scheme' });
        } else {
            M.setScheme(scheme);
        }
    }
    M.setBaseUrl(baseUrl);
    $('#baseUrl').value = M.baseUrl;
    $('#scheme').value = M.scheme;
    if (segments.length > 1) {
        let lang = segments[1];
        M.setLang(lang);
    }
    onUrlChange();
}

function clearHash() {
    history.pushState("", document.title, window.location.pathname + window.location.search);
}
function updateHash() {
    if (!M.baseUrl) {
        clearHash();
    } else {
        let activeLang = $('.lang.active');
        let url = M.baseUrl;
        if (url.indexOf('://') === -1)
            url = M.scheme + '://' + url;
        let slug = urlToSlug(url);
        location.hash = activeLang
            ? `${slug}/${activeLang.getAttribute('data-lang')}` 
            : slug;
    }
}

function activateLang() {
    $$('.lang').forEach(el => { 
        if (el.getAttribute('data-lang') === M.lang) 
            el.classList.add('active');
        else
            el.classList.remove('active');
    });
}
function clearTags(e) {
    $$('.tag.active').forEach(el => { if (el !== e) el.classList.remove('active') });
}

function getOperations(meta, tag) {
    return tag
        ? meta.operations.filter(x => x.tags && x.tags.indexOf(tag) >= 0).map(op => op.request.name)
        : meta.operations.map(op => op.request.name);
}

let opsAwesomplete = null; 
function updateLang() {
    if (!M.lang) return;

    let $form = $('#apiForm form');
    if (LOG) console.log('$form',$form);
    if ($form) {
        applyForm($form);
        return;
    }

    clearErrorSummary();
    setLoading('#embed-loading');
    client.get(new GistRef({ slug:M.slug(), lang:M.lang }))
        .then(r => {
            showEmbed(r);
        })
        .finally(() => endLoading('#embed-loading'));
    
    getSiteMeta(M.slug(), meta => {
        let sortFn = (x,y) => x > y ? 1 : -1;
        let ops = getOperations(meta);
        //if (LOG) console.log(`selectLang ops *`, ops);
        if (opsAwesomplete) {
            opsAwesomplete.destroy();
            opsAwesomplete = null;
        }
        opsAwesomplete = new Awesomplete('#txtRequest', { list:ops, sort:sortFn });
        let tagNames = uniq(flatMap(x => x.tags, meta.operations.filter(x => x.tags)));
        let sb = new StringBuffer();
        tagNames.forEach(tag => 
            sb.append(`<div class="tag text-xs inline-flex items-center font-bold leading-4 uppercase px-3 py-1 mr-1 bg-blue-100 text-blue-500 rounded-full cursor-pointer" data-tag="${tag}" data-click="selectTag">${tag}</div>`));
        $("#tags").innerHTML = sb.toString();
    });
    updateDownload();
}

let SITES = {};
function getSiteMeta(slug, cb) {
    if (SITES[slug]) {
        cb(SITES[slug])
    } else {
        client.get(new SiteMeta({ slug:slug }))
            .then(r => {
                cb(SITES[slug] = r.api)
            });
    }
}

function setLoading(sel) {
    $$(sel).forEach(el => el.parentElement.classList.add('loading'));
}
function endLoading(sel) {
    $$(sel).forEach(el => el.parentElement.classList.remove('loading'));
}

function gistUrl(url) {
    return `https://localhost:5001/embed?gist=` + encodeURIComponent(url);
}

function showEmbed(r) {
    let $embed = $('#embed');
    let embedUrl = gistUrl(`https://${r.id}`);
    $embed.innerHTML = `<iframe id="iframe" class="w-wide-section h-embed" src="${embedUrl}">`;
}

function onUrlChange() {
    let $baseUrl = $('#baseUrl'), $scheme = $('#scheme'), $lang = $('.lang.active');
    let oldBaseUrl = M.baseUrl;
    M.setScheme($scheme.value);
    M.setBaseUrl($baseUrl.value);
    if (M.baseUrl !== oldBaseUrl) {
        clearForm();
    }
    M.setLang($lang ? $lang.getAttribute('data-lang') : null);
    $scheme.value = M.scheme;
    $baseUrl.value = M.baseUrl;
    updateLang($lang);
    updateHash();
}

on('#formUrl', { submit: e => { e.preventDefault(); onUrlChange(); } });
on('#scheme,#baseUrl', { change: onUrlChange });
on('#btn-clear div', {
    click: function (e) {
        M.reset();
    }
})

function setError(status, defaultTitle) {
    let $error = $('#error-summary');
    $error.querySelector('b').innerHTML = status.errorCode || defaultTitle || 'Error';
    let pos = status.message ? status.message.indexOf('(Parameter ') : -1;
    $error.querySelector('p').innerHTML = pos >= 0 ? status.message.substring(0,pos) : status.message;
    M.setErrorStatus(status);
}
function clearErrorSummary() { 
    let $error = $('#error-summary');
    $error.querySelector('b').innerHTML = '';
    $error.querySelector('p').innerHTML = '';
    M.setErrorStatus(null);
}
function clearForm() {
    clearErrorSummary();
    $('#apiForm').innerHTML = '';
    updateDownload();
}

window.onhashchange = function () {
    handleHash(location.hash.substring(1));
}

function findType(meta, typeName, namespace) {
    let type = meta.types.find(x => x.name === typeName && (!namespace || x.namespace === namespace))
        || meta.operations.map(x => x.request).find(x => x.name === typeName && (!namespace || x.namespace === namespace))
        || meta.operations.map(x => x.response).filter(x => x != null)
            .find(x => x.name === typeName && (!namespace || x.namespace === namespace));
    return type;
}
function trimPrefixes(str,c) {
    return str.replace(new RegExp(`^${c}+`,'g'),'');
}
let NumericTypes = ['Byte','SByte','Int16','Int32','Int64','UInt16','UInt32','UInt64','Single','Double','Decimal'];
function isNumeric(type) { return NumericTypes.indexOf(type) >= 0; }

let BuiltInTypes = ['String','Boolean','DateTime','TimeSpan','Char','Guid'].concat(NumericTypes);
let IgnoreTypes = ['KeyValuePair`2'];

function typeInfo(meta,prop) {
    let type = prop.type === "Nullable`1"
        ? prop.genericArgs[0]
        : prop.type;
    let isArray = type.endsWith("[]");
    let elementType = isArray
        ? leftPart(type,'[')
        : null;
    let enumType = prop.isEnum === true
        ? findType(meta, prop.type, prop.typeNamespace)
        : null;
    let collectionType = prop.typeNamespace === "System.Collections.Generic"
        ? `${trimPrefixes(leftPart(prop.type,'`'),'I')}<${prop.genericArgs.join(',')}>`
        : null;
    if (collectionType) {
        elementType = prop.genericArgs.length === 1 
            ? prop.genericArgs[0]
            : prop.genericArgs.length === 2
                ? `KeyValuePair<${prop.genericArgs.join(',')}>`
                : null;
    }
    let metaType = findType(meta, type, prop.typeNamespace);
    let info = {
        meta: metaType,
        type: type,
        namespace: (metaType && metaType.namespace) || prop.typeNamespace,
        isArray: isArray,
        elementType: elementType,
        isEnum: enumType != null,
        enumType: enumType,
        collectionType: collectionType,
        isDictionary: collectionType != null && collectionType.indexOf('Dictionary') >= 0,
        isString: type === 'String',
        isChar: type === 'Char',
        isGuid: type === 'Guid',
        isNumeric: isNumeric(type),
        isDateTime: type === 'DateTime' || type === 'DateTimeOffset',
        isTimeSpan: type === 'TimeSpan',
        isBoolean: type === 'Boolean',
        isGeneric: type.indexOf('`') >= 0,
        isBuiltIn: elementType || BuiltInTypes.indexOf(type) >= 0,
    };
    info.isClass = metaType != null || (!info.isNumeric && !BuiltInTypes.indexOf(type));
    info.ignore = IgnoreTypes.indexOf(type) >= 0 || info.isDictionary || (BuiltInTypes.indexOf(type) === -1 && !info.elementType);
    if (LOG) console.log(`typeInfo(${prop.type})`, info);
    return info;
}

function typeProperties(meta,type) {
    let to = [];
    if (type == null)
        return to;
    
    do {
        if (type.properties) {
            type.properties.forEach(x => {
                to.push(x);
            });
        }
        type = type.inherits
            ? findType(meta, type.inherits.name, type.inherits.namespace)
            : null;
    } while (type != null);
    
    return to;
}
let PosIntFields = ['Skip','Take'];
let MultiPropFields = ['OrderBy','OrderByDesc','Fields'];
let NarrowFields = ['Skip','Take','OrderBy','OrderByDesc'];
function createInput(prop,info,meta) {
    let attrs = {
        id:prop.name,
        name:prop.name,
        type:'text',
        'class':'mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md',
        autocomplete:prop.name
    };
    if (info.elementType && isNumeric(info.elementType)) {
        attrs.title = "comma-delimited list of numbers";
        attrs.pattern = "[0-9.,]*";
        attrs.onblur = "this.reportValidity()";
    }
    else if (info.isNumeric) {
        attrs.type = 'number';
        let posIntOnly = PosIntFields.indexOf(prop.name) >= 0 || info.type.startsWith('U');
        if (posIntOnly) {
            attrs.min = "0";
            attrs.oninput = "validity.valid||(value='')";
        }
    }
    else if (info.isDateTime) {
        attrs.type = 'datetime-local';
    }
    else if (info.isTimeSpan) {
        attrs.pattern = "^((((?:-?0*\\d+\\.)?(?:0*)(?:2[0-3]|1[0-9]|[0-9]))(?::0*([0-5]?[0-9]))?(?::0*((?:[0-5]?[0-9])(?:\\.\\d{0,7})?)))|(\\d+))?$";
        attrs.title = "valid TimeSpan format: (D.)HH:MM:SS(.fff)";
        attrs.onblur = "this.reportValidity()";
    }
    else if (info.isChar) {
        attrs.maxlength = 1;
    }
    else if (info.isGuid) {
        attrs.pattern = "^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$";
        attrs.title = "Valid UUID format";
        attrs.onblur = "this.value = toUUID(this.value); this.reportValidity()";
    }
    return `<input ${htmlAttrs(attrs)}>`;
}
function createControl(prop,info,meta,opt) {
    if (info.isBoolean) {
        return `<fieldset class="col-span-6">
        <div class="mt-4 space-y-4">
          <div class="flex items-start">
            <div class="flex items-center h-5">
              <input id="${prop.name}" name="${prop.name}" type="checkbox" value="true" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
            </div>
            <div class="ml-3 text-sm">
              <label for="${prop.name}" class="font-medium text-gray-700">${humanize(prop.name)}</label>
            </div>
          </div>
        </div>
        </fieldset>`;
    }
    return `<div class="${opt.colClass}">
        <label for="${prop.name}" class="block text-sm font-medium text-gray-700">${humanize(prop.name)}</label>
        ${createInput(prop,info,meta)}
    </div>`;
}

function isAutoQuery(request) {
    return request.inherits && request.inherits.name.startsWith('Query');
}

function toUUID(s) {
    if (!s) return s;
    if (s.length === 32) {
        return s.substring(0,8) + '-' + s.substring(8,12) + '-' + s.substring(12,16) + '-' + s.substring(16,20) + '-' + s.substring(20);
    }
    return s;
}

function createForm(request, meta) {
    let aqRequest = isAutoQuery(request);
    let formCls = aqRequest || true ? '' : 'overflow-hidden sm:rounded-md'; //don't clip popups

    let sb = new StringBuffer(
        `<form onsubmit="return applyForm(this)">
            <div class="shadow ${formCls}">
              <div class="px-4 py-5 bg-white sm:p-6">
                <div class="grid grid-cols-6 gap-3">`);
    
    let props = typeProperties(meta,request);
    props.forEach(prop => {
        let info = typeInfo(meta,prop);
        if (info.ignore) return;
        let opt = {
            colClass: info.isNumeric || info.isDateTime || info.isTimeSpan || info.isChar ? 'col-span-3' : 'col-span-6'
        };
        if (aqRequest) {
            if (prop.name === 'Include')
                return;
            if (prop.name === 'Skip')
                sb.append('<hr class="col-span-6 mt-2">');             
            if (NarrowFields.indexOf(prop.name) >= 0)
                opt.colClass = 'col-span-3';
        }
        sb.append(createControl(prop,info,meta,opt));
    });
    sb.append(`</div>
      </div>`);
    
    sb.append(`<div class="px-4 py-3 bg-gray-50 text-right sm:px-6">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                  Update
                </button>
            </div>
        </div>
    </form>`)
    return sb.toString();
}

function applyForm(form) {
    updateDownload();    
    if (!form) return;
    let opName = $('#txtRequest').value;
    let obj = serializeToObject(form);
    if (LOG) console.log('applyForm', opName, obj);
    if (!opName) return false;
    let url = combinePaths(location.origin,'gists',M.slug(),M.getLang(),opName);
    getSiteMeta(M.slug(), meta => {
        let op = meta.operations.find(x => x.request.name === opName);
        let request = op.request;
        let args = new StringBuffer();
        let props = typeProperties(meta,request);
        props.forEach(prop => {
            let value = obj[prop.name];
            if (!value) return;
            value = trimEnd(value.trim(),',');
            let info = typeInfo(meta,prop);
            if (args.getLength() > 0)
                args.append(',');
            args.append(prop.name);
            args.append(':');
            if (info.elementType)
                args.append(`[${value}]`);
            else
                args.append(JSV.stringify(value));
        });
        let iframeSrc = gistUrl(url + '(' + args.toString() + ')');
        if (LOG) console.log('iframeSrc',iframeSrc);
        $('#iframe').src = iframeSrc;  
    });
    return false;
}

function updateDownload() {
    let dtoOptions = [{ id:'includeAll', label: 'All', value:'*' }];
    let $selectedTag = $('#tags .active');
    if ($selectedTag) {
        let tag = $selectedTag.getAttribute('data-tag');
        dtoOptions.push({ id:'includeTag', label: `Only ${tag} DTOs`, value: '{' + tag + '}' });
    }
    let $txtRequest = $('#txtRequest');
    if ($txtRequest.value) {
        dtoOptions.push({ id:'includeRequest', label: `Only ${$txtRequest.value} DTOs`, value: '' });
    }
    
    let selectedInclude = M.getInclude();
    let selectedOption = dtoOptions.find(x => x.id === selectedInclude) || dtoOptions[dtoOptions.length-1];
    selectedOption.checked = true;

    let sb = new StringBuffer();
    dtoOptions.forEach(x => {
        let checked = x.checked === true ? ' checked' : '';
        sb.append(`<div class="flex items-center">
            <input id="${x.id}" name="include" value="${x.value}" ${checked} type="radio" onchange="M.setInclude('${x.id}')" 
                   class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                <label for="${x.id}" class="ml-3 block text-sm font-medium text-gray-700">${x.label}</label>
        </div>`);
    });
    let includeHtml = `<fieldset>
          <div>
            <legend class="uppercase text-base font-medium text-gray-900">Include DTOs</legend>
          </div>
        <div class="mt-4 space-y-4">${sb.toString()}</div>
    </fieldset>`;
    
    let projectName = $('#txtProjectName').value || 'MyApp';

    $('#includeDtos').innerHTML = includeHtml;
    $('#lblProject').innerHTML = `${projectName}.zip`;
    
    //$('#customForm').innerHTML = ``;
}

let awesompleteInstances = [];
function clearAwesompleteInstances() {
    if (awesompleteInstances.length > 0) {
        awesompleteInstances.forEach(x => x.destroy());
        awesompleteInstances = [];
    }
}

function selectOp(opName) {
    if (!opName) {
        clearForm();
        return;
    }
    getSiteMeta(M.slug(), meta => {
        let op = meta.operations.find(x => x.request.name === opName);
        if (!op) return;
        if (op.requiresAuth)
            document.body.classList.add('requires-auth');
        else
            document.body.classList.remove('requires-auth');

        clearAwesompleteInstances();

        let $apiForm = $('#apiForm');
        $apiForm.innerHTML = createForm(op.request, meta);

        if (isAutoQuery(op.request)) {
            let targetName = op.request.inherits.genericArgs[0];
            let target = findType(meta, targetName);
            if (target) {
                let targetPropNames = typeProperties(meta, target).map(x => x.name);
                let props = typeProperties(meta,op.request).filter(prop => MultiPropFields.indexOf(prop.name) >= 0);
                let cache = {};
                props.forEach(prop => {
                    let id = prop.name;
                    let $input = $(`#${id}`);
                    let instance = new Awesomplete($input, {
                        list: targetPropNames,
                        filter: function(text, input) {
                            //console.log('filter', text, input, 1, input.indexOf(text.value + ','))
                            if (input.indexOf(text.value + ',') >= 0)
                                return false;
                            return Awesomplete.FILTER_CONTAINS(text, input.match(/[^,]*$/)[0]);
                        },
                        item: function(text, input) {
                            return Awesomplete.ITEM(text, input.match(/[^,]*$/)[0]);
                        },
                        replace: function(text) {
                            let before = this.input.value.match(/^.+,\s*|/)[0];
                            this.input.value = before + text + ", ";
                        }
                    });
                    on($input, {
                        mousedown: function () {
                            let instance = awesompleteInstances.find(x => x.input === this);
                            if (instance) {
                                instance.evaluate();
                                instance.open();
                            }
                        }
                    })
                    awesompleteInstances.push(instance);
                    if (LOG) console.log('awesompleteInstances', awesompleteInstances)
                });
            } else if (LOG) console.error(`Could not find table: ${targetName}`);
        }

        let $input = $$('input,select,textarea',$apiForm)[0];
        if ($input) $input.focus();

        applyForm($('#apiForm form'));
    });
}

function init() {
    let { bindHandlers, leftPart, rightPart, JsonServiceClient, GistRef, SiteMeta, humanize, enc, 
          StringBuffer, JSV, htmlAttrs, serializeToObject, combinePaths, trimEnd, uniq, flatMap } = exports;
    Object.assign(window, { leftPart, rightPart, JsonServiceClient, GistRef, SiteMeta, humanize, 
        enc, StringBuffer, JSV, htmlAttrs, serializeToObject, combinePaths, trimEnd, uniq, flatMap });
    client = new JsonServiceClient();
    client.exceptionFilter = (res,err) => {
        setError(err.responseStatus || err, res.statusText || res.status);
        console.log(err);
    };

    if (location.hash) {
        handleHash(location.hash.substring(1));
    }
    bindHandlers({
        selectLang: function (e) {
            let lang = !this.classList.contains('active') 
                ? this.getAttribute('data-lang') 
                : null;
            M.setLang(lang);
            updateLang();
            updateHash();
        },
        selectTag: function () {
            clearTags(this);
            this.classList.toggle('active');
            let tag = this.classList.contains('active') 
                ? this.getAttribute('data-tag')
                : null;
            $('#txtRequest').value = '';
            getSiteMeta(M.slug(), meta => {
                let ops = getOperations(meta, tag);
                if (LOG) console.log(`selectTag ops ${tag ?? '*'}`, ops);
                opsAwesomplete.list = ops;
                opsAwesomplete.input.focus();
            });
            updateDownload();
        },
        openWith: function () {
            //alert('opening with ' + this.getAttribute('data-open'));
        }
    });
    on('#txtRequest', {
        'awesomplete-select': function (evt) {
            let opName = evt.text.value;
            if (!opName) return;
            if (LOG) console.log('awesomplete-select', opName, $('#txtRequest').value);
            selectOp(opName);
        },
        blur: function () {
            setTimeout(function () {
                let opName = $('#txtRequest').value;
                if (LOG) console.log('blur', opName);
                selectOp(opName);
            }, 0)
        }
    })
}
document.addEventListener('DOMContentLoaded',init);

</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-RFJMWNBD9F"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-RFJMWNBD9F');</script>

<link rel="stylesheet" href="assets/lib/awesomplete.css">
<script src="assets/lib/awesomplete.js"></script>

</body>
</html>